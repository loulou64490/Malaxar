#!/bin/bash

# Gestion de l'option -v (doit être le premier argument pour être pris en compte par le script)
USE_VALGRIND=true

if [ "$1" == "-v" ]; then
    USE_VALGRIND=false
    shift # On retire -v des arguments
fi

SOURCE_FILE="$1"

# Vérifications de base
if [ -z "$SOURCE_FILE" ]; then
    echo "Usage: mx [-v] fichier.c [arg1 arg2 ...]"
    exit 1
fi

if [[ ! -f "$SOURCE_FILE" ]]; then
    echo "Erreur : Le fichier '$SOURCE_FILE' est introuvable."
    exit 1
fi

# On vérifie que c'est bien un fichier .c pour extraire le nom de l'exécutable
if [[ "$SOURCE_FILE" != *.c ]]; then
    echo "Erreur : Le fichier doit avoir l'extension .c"
    exit 1
fi

# Nom de l'exécutable : on retire l'extension .c
OUTPUT_BIN="${SOURCE_FILE%.c}"

# 1. Compilation
# gcc fichier.c -o fichier -Wall -Wextra -O0 -g3 -lm
gcc "$SOURCE_FILE" -o "$OUTPUT_BIN" -Wall -Wextra -O0 -g3 -lm

# Si la compilation échoue, on arrête tout
if [ $? -ne 0 ]; then
    echo "Échec de la compilation."
    exit 1
fi

# On décale les arguments pour ne garder que ceux destinés au programme (arg1 arg2 etc)
shift

# 2. Exécution
if [ "$USE_VALGRIND" = true ]; then
    # Avec Valgrind
    valgrind --quiet --leak-check=full --track-origins=yes --show-leak-kinds=all "./$OUTPUT_BIN" "$@"
else
    # Sans Valgrind (si option -v présente)
    "./$OUTPUT_BIN" "$@"
fi
